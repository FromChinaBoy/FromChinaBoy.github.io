<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="https://www.w3.org/2005/Atom">
	<channel>
		<title>Blog</title>
		<description>fromChinaBoy</description>
		<link>/</link>
		<atom:link href="/" rel="self" type="application/rss+xml" />
		
			<item>
				<title>iptables和nginx配置防御cc学习</title>
				<description>&lt;h2 id=&quot;问题概述&quot;&gt;问题概述&lt;/h2&gt;
&lt;p&gt;上一篇文章配置了iptables两条命令，就觉得没问题了，但是我太天真了，归咎原因还是没有好好
学iptables的内在意思。&lt;/p&gt;

&lt;p&gt;配置的iptables两条命令&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 30 -j REJECT
sudo iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;解释下这两条命令，意思都是表示在同一时刻最大的tcp为30连接数限制，超过30连接数就会被reject拒绝。&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;记住是同一时刻！！!&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;同一时刻，即是tcp处于ESTABLISHED连接状态的。那这些怎么看呢？&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;案例&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat  | grep :443

Proto Recv-Q Send-Q Local-Address           Foreign-Address         State
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN     
tcp        0      0 172.18.245.246:443      113.67.9.211:14451      TIME_WAIT  
tcp        0      1 172.18.245.246:42776    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14442      TIME_WAIT  
tcp        0      0 172.18.245.246:42388    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42748    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14540      TIME_WAIT  
tcp        0      1 172.18.245.246:42690    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42682    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14559      TIME_WAIT  
tcp        0      1 172.18.245.246:42694    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42564    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42706    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:42380    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42396    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42674    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      47.106.188.48:42236     ESTABLISHED
tcp        0      1 172.18.245.246:42610    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42606    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42592    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:42294    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42342    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14498      TIME_WAIT  
tcp        0      0 172.18.245.246:443      47.106.188.48:42278     ESTABLISHED
tcp        0      1 172.18.245.246:42558    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      47.106.188.48:42272     ESTABLISHED
tcp        0      0 172.18.245.246:443      47.106.188.48:42252     ESTABLISHED
tcp        0      0 172.18.245.246:443      113.67.9.211:14543      TIME_WAIT  
tcp        0      1 172.18.245.246:42746    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42788    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14570      TIME_WAIT  
tcp        0      0 172.18.245.246:42270    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42792    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14493      TIME_WAIT  
tcp        0      0 172.18.245.246:42370    47.106.188.48:443       ESTABLISHED
tcp        0      0 172.18.245.246:443      113.67.9.211:14445      TIME_WAIT  
tcp        0      1 172.18.245.246:42688    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42570    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42328    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      47.106.188.48:42292     ESTABLISHED
tcp        0      0 172.18.245.246:42278    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42216    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14550      TIME_WAIT  
tcp        0      0 172.18.245.246:443      113.67.9.211:14487      TIME_WAIT  
tcp        0      1 172.18.245.246:42774    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14425      TIME_WAIT  
tcp        0      1 172.18.245.246:42726    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42390    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14578      TIME_WAIT  
tcp        0      0 172.18.245.246:443      113.67.9.211:14564      TIME_WAIT 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;统计对外443端口连接数&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat|grep &quot;47.106.188.48:443&quot;|wc -l
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;统计对外443已连接上的，状态为ESTABLISHED&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat | grep ESTABLISHED | grep 47.106.188.48:443 | wc -l  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;统计对外443等待连接的，状态为SYN_SENT&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat | grep SYN_SENT | grep 47.106.188.48:443 | wc -l  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;iptables配置完后，过几天又出现了nginx的502情况，在nginx error查看当时的那个时间段的该ip的请求失败数。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;grep '2020/01/01 19:02:31' xxx.com.error.log|wc -l   //结果显示62个请求失败数
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;初步猜想&lt;/code&gt;：nginx error显示62个请求失败数! 保持30个连接数量，但是请求却是一直在请求，动态语言php-cgi处理不过来，nginx
传过来的请求，就会直接返回错误。导致nginx直接将请求，记做错误写入error日志。&lt;/p&gt;

&lt;p&gt;画个流程图：
&lt;img src=&quot;http://img.zzhpeng.cn/Fk7-M-U3c-LFEmPmzOe_bmNwuRNx&quot; alt=&quot;图&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;iptables学习与测试&quot;&gt;iptables学习与测试&lt;/h2&gt;
&lt;p&gt;本测试在测试环境测试，环境参数为4g内存2个核心1M带宽，系统环境是ubuntu16.4，该发行版本的默认管理防火墙的工具是ufw。&lt;/p&gt;

&lt;h3 id=&quot;无任何防御测试&quot;&gt;无任何防御测试&lt;/h3&gt;
&lt;p&gt;压测服务器ab命令 ab -c 20 -n 1000 https://dev.xxx.com/，全部通过
&lt;img src=&quot;http://img.zzhpeng.cn/FrN6NF5LYoD3J9BZL37rzHsm0OVK&quot; alt=&quot;ab命令&quot; /&gt;&lt;/p&gt;

&lt;p&gt;服务器tcp连接数变化
&lt;img src=&quot;http://img.zzhpeng.cn/FsCP9OnEiddWnKI1bMMQtKdTSEV0&quot; alt=&quot;tcp连接数变化&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;iptables防御&quot;&gt;iptables防御&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;查看iptables状态&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ufw status  //会显示 Status: active ，证明已经开启
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;iptables 命令&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;添加，防御同一时刻20连接数限制&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 20 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;删除防御同一时刻20连接数限制&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -D INPUT -p tcp --dport 443 -m connlimit --connlimit-above 20 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看是否生效&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -nL
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;开机生效&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;自查
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;iptables 测试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;压测服务器ab命令 ab -c 20 -n 1000 https://dev.xxx.com/，少部分失败
&lt;img src=&quot;http://img.zzhpeng.cn/FjGLx-JepP-Q4JvMxYOOnNIMMQEW&quot; alt=&quot;ab命令&quot; /&gt;&lt;/p&gt;

&lt;p&gt;服务器tcp连接数变化,压测中的建立连接数不超过20
&lt;img src=&quot;http://img.zzhpeng.cn/FhjpjR9Px6Y4sbo1l6f_d3ek0XIk&quot; alt=&quot;tcp连接数变化&quot; /&gt;&lt;/p&gt;

&lt;p&gt;加强压测，压测服务器ab命令 ab -c 25 -n 1000 https://dev.xxx.com/ 
&lt;img src=&quot;http://img.zzhpeng.cn/FoJbn_IqOilb6IX1SYq-npWaMxmA&quot; alt=&quot;ab命令&quot; /&gt;&lt;/p&gt;

&lt;p&gt;服务器tcp连接数变化，压测中的建立连接数不超过20
&lt;img src=&quot;http://img.zzhpeng.cn/FgjeblbI2m_2fElE8MwK1cs-9Y5M&quot; alt=&quot;tcp连接数变化&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;nginx-cc防御设置&quot;&gt;nginx cc防御设置&lt;/h2&gt;
&lt;p&gt;即是是配置了iptables还是会出现502，查看大量请求的ip，这个ip是某个正常使用的门店，但是为什么会出现大量的请求呢？
推测F5,模拟测试。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;F5模拟测试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;F5模拟测试,果然系统抛出502，我按出了浏览器显示差不多1200多个请求。
&lt;img src=&quot;http://img.zzhpeng.cn/FkNU7r-CYTOdCTYzFylfeR4PCdFr&quot; alt=&quot;tcp连接数变化&quot; /&gt;&lt;/p&gt;

&lt;p&gt;然后，我在测试服务器，查看tcp变化数，限制到了20个连接数。自我推测：持续1200个请求下来，
存在了很多等待连接的。数据库返回数据慢了或者奔溃了，php-fpm响应超时重启出现502。&lt;/p&gt;

&lt;p&gt;如图下，为F5请求产生502后，查看服务器tcp情况，还保持着20个连接数，和80个准备连接数。
&lt;img src=&quot;http://img.zzhpeng.cn/FmQH6dfFWvqmgHrcTF_EcpYUjQPW&quot; alt=&quot;tcp连接数变化&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;结论：iptable的限制20个连接数，能限制流量，但是F5攻击触及到数据库，就存在数据库那边的读的压力。
如果是静态或者缓存资源的的响应是没问题的，所以这里找到了nginx的cc防御。遇到一个时间段过多的流量可以抛出
个网络异常或503响应给浏览器，这样用户持续的F5就不会影响服务器了&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;nginx.conf主配置&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    limit_conn_zone $binary_remote_addr zone=perip:10m;//远端ip 限制 
    limit_conn_zone $server_name zone=perserver:10m;//服务器域名 限制
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;容器共使用10M的内存来对于IP传输开销&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;server.conf某个网站&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    limit_conn perserver 300;//远端服务器域名 300个并发限制
    limit_conn perip 25;//远端ip25个并发 限制
    limit_rate 1024k;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;limit_rate 512k： 对每个连接限速512k. 注意，这里是对连接限速，而不是对IP限速。如果一个IP允许两个并发连接，那么这个IP就是限速limit_rate×2。&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;配置，这里我直接用了宝塔的UI配置，这里是在server外部配置的，全局。
&lt;img src=&quot;http://img.zzhpeng.cn/Fp8s437_mKXOffD-bKDyTub_vxg4&quot; alt=&quot;宝塔设置&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;F5再次模拟测试&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;再次显示f5 65次就网络出错了，f5防御成功。
&lt;img src=&quot;http://img.zzhpeng.cn/Fubhh6oFbkaA5UBA9Et61YUcPFLp&quot; alt=&quot;F5再次模拟测试&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;恍然大悟&quot;&gt;恍然大悟&lt;/h2&gt;
&lt;p&gt;1、前几次出现的f5攻击，只有上千条单个ip的error就停了，并且出现nginx 502。而最近f5攻击达到了上万条单个ip的error，这个就是
设置的iptables做了限制作用了，只允许30个连接数，数据库短暂压力没那么大，可以持续更长的时间。&lt;/p&gt;

&lt;p&gt;2、iptables 设置了30个连接数限制，但是为什么单个ip会有上万个error错误呢？这里就牵着到了浏览器http2协议当中，一个tcp多路复用
可以传输多个http请求。&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020年01月06日 16:54:00 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://help.ubuntu.com/community/UFW&quot;&gt;UFW - Community Help Wiki&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://help.ubuntu.com/community/IptablesHowTo&quot;&gt;IptablesHowTo - Community Help Wiki&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/MacoLee/p/6023201.html&quot;&gt;Nginx限速遇到的问题 - MacoLee - 博客园&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.httpclient.cn/archives/106.html&quot;&gt;服务器TIME_WAIT和CLOSE_WAIT分析和解决办法 - HttpClient 中文官网&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/williamjie/p/11075565.html&quot;&gt;一个 TCP 连接可以发多少个 HTTP 请求 - 割肉机 - 博客园&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 06 Jan 2020 00:00:00 +0800</pubDate>
				<link>/iptables-nginx-cc.html</link>
				<guid isPermaLink="true">/iptables-nginx-cc.html</guid>
			</item>
		
			<item>
				<title>生产环境又出现nginx502了！！</title>
				<description>&lt;h2 id=&quot;问题概述&quot;&gt;问题概述&lt;/h2&gt;
&lt;p&gt;在某段时间段，网站出现nginx 502，通过宝塔查看，负载状态是100%，查看监控，磁盘IO飙高，如下为近7日IO磁盘图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FilqyanVhrxGwgOxksnDlyWAnw-W&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;排查数据&quot;&gt;排查数据&lt;/h2&gt;

&lt;p&gt;nginx抛出502，证明是它的反向代理出错，这个代理php-cgi出了问题，我用的是php-fpm，出了问题。
查看php-fpm 日志，发现并没有什么异常，提示需要提升start_servers是因为在这个时候我reload了php-fpm，
但是reload后并没作用。然后重启了nginx，才恢复了正常。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FvPOyQL4h5T7VN73ltMSw5TyGP9L&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;查看nginx 日志，出现了很多*12359859 connect() to unix:/tmp/php-cgi-72.sock failed
 (11: Resource temporarily unavailable) while connecting to upstream&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FqX_zzcPU42pDzGR9dXbL9m-DG3p&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;根据nginx这个提示查了相关资料，得到了3个解决方案&lt;/p&gt;
&lt;h3 id=&quot;1php-fpm的sock通讯方式-改为-tcp&quot;&gt;1、php-fpm的sock通讯方式 改为 tcp&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;结论：不考虑，查了相关的blog，出现了相同问题，还从tcp改为sock模式呢！！&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;2用两个php-fpm-socknginx负载均衡&quot;&gt;2、用两个php-fpm sock，nginx负载均衡&lt;/h3&gt;
&lt;p&gt;2.1、复制一份配置文件，修改里边的pid sock
cp /usr/local/php/etc/php-fpm.conf cp /usr/local/php/etc/php-fpm2.conf&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
pid = /usr/local/php/var/run/php-fpm2.pid
error_log = /usr/local/php/var/log/php-fpm2.log
log_level = notice

[www]
listen = /tmp/php-cgi2.sock
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.2、复制一个启动文件，也修改相关的信息&lt;/p&gt;

&lt;p&gt;cp /etc/init.d/php-fpm /etc/init.d/php-fpm2&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;php_fpm_BIN=${exec_prefix}/sbin/php-fpm
php_fpm_CONF=${prefix}/etc/php-fpm2.conf
php_fpm_PID=${prefix}/var/run/php-fpm2.pid
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.3、启动
/etc/init.d/php-fpm2 start&lt;/p&gt;

&lt;p&gt;2.4、nginx 配置文件，增加 upstream模块&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;upstream backend{
    server unix:/tmp/php-cgi.sock;
    server unix:/tmp/php-cgi2.sock;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.5、把fastcgi_pass unix:/tmp/php-cgi.sock;改成 fastcgi_pass  backend;
重新加载
/etc/init.d/nginx reload&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;结论：这个方法，和我直接调大php-fpm max_children差不多，不考虑。&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;3php-fpm的listenbacklog默认-1改为1024或者4096即是调大&quot;&gt;3、php-fpm的listen.backlog默认-1改为1024或者4096，即是调大&lt;/h3&gt;
&lt;p&gt;V友:onepunch回复，整理如下&lt;/p&gt;

&lt;h4 id=&quot;调查&quot;&gt;调查&lt;/h4&gt;
&lt;p&gt;nginx (客户端) 和 php-fpm （服务端） 通过 unix socket 通信，在 connet() 时，会进行类似 tcp 的三次握手,
如果 accpet queue 队列满了，server 将发送一个 ECONNREFUSED 错误信息 Connection refused 到 client。
这样 nginx 就会报这个错了，连接不上。php-fpm 的 backlog 是 accpet queue 的最大长度&lt;/p&gt;

&lt;p&gt;查看系统内核的最大长度&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat /proc/sys/net/core/somaxconn 128
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看 php-fpm 里的配置 listen.backlog 是 4096，由于会取这 2 个的最小值， 所以是 128。&lt;/p&gt;

&lt;p&gt;验证当时的请求：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;grep '2019-12-06T16:48' bi_svc.access.log.1 | wc -l //9903
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;计算9903/60等于每秒请求数165，165&amp;gt;128 了, 请求太多了，应该是 accpet queue 满了&lt;/p&gt;

&lt;h4 id=&quot;解决办法&quot;&gt;解决办法&lt;/h4&gt;
&lt;p&gt;vi /etc/sysctl.conf&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;net.core.somaxconn = 1024
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;将 /proc/sys/net/core/somaxconn 改成 1024 就不会出问题了&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;结论：这个方法是稳定PV提升、IO提升的解决方案，不过我这边遇到的是突然的提升，所以我这边不会这样子做&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;更多服务器信息&quot;&gt;更多服务器信息&lt;/h2&gt;
&lt;h3 id=&quot;1云服务器ecs&quot;&gt;1、云服务器ECS&lt;/h3&gt;
&lt;p&gt;1.1、系统磁盘BPS，其他监控内容无太大的异常
&lt;img src=&quot;http://img.zzhpeng.cn/Fuk7Hg7v9LETTlt6lJIe7EcKeLoD&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;2rds数据库&quot;&gt;2、RDS数据库&lt;/h3&gt;
&lt;p&gt;2.1、-网络流量
&lt;img src=&quot;http://img.zzhpeng.cn/Fo5pktGwx-j4lERPURRBcVnQekPA&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.2、RDS数据库-CPU使用率
&lt;img src=&quot;http://img.zzhpeng.cn/Fs_A1vSJ9M5MrVF9dLMktQ6vq5u5&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.3、RDS数据库-TPS/QPS
&lt;img src=&quot;http://img.zzhpeng.cn/FuCeHHk2YnWJkzsfGBEHQGp2MhAc&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.4、RDS数据库-慢日志
&lt;img src=&quot;http://img.zzhpeng.cn/FsSPL2M079cfnmeqN7LmX7-wE3lo&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;最后选择&quot;&gt;最后选择&lt;/h2&gt;
&lt;p&gt;用户请求飙升，平台又没有做什么活动，查看了nginx access log，分析同一个ip，同一时间段上百个请求同
一个访问链接，所以决定iptable限制下，控制单个IP的最大30并发连接数。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 30 -j REJECT
sudo iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;后续&quot;&gt;后续&lt;/h2&gt;
&lt;p&gt;问题还是出现了，查看下一篇post&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2019年12月27日 15:29:00 初稿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.v2ex.com/t/632647&quot;&gt;nginx+ PHP -fpm 出现 502&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/chengxuyuanyonghu/article/details/54409523&quot;&gt;iptables限制同一IP连接数&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/lilidun/p/5801437.html&quot;&gt;centos 7 iptables基本配置&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Thu, 26 Dec 2019 00:00:00 +0800</pubDate>
				<link>/nginx502_2.html</link>
				<guid isPermaLink="true">/nginx502_2.html</guid>
			</item>
		
			<item>
				<title>生产环境出现nginx502,导致十来分钟系统奔溃（Tp5.1的session bug）</title>
				<description>&lt;h2 id=&quot;问题概述&quot;&gt;问题概述&lt;/h2&gt;
&lt;p&gt;使用PHP的ThinkPHP5.1开发框架，生产环境使用宝塔管理，其中nginx直接报错502，继续时间10来分钟。而且通过观察，一段时间又会出现，特别是复杂频繁的操作。&lt;/p&gt;

&lt;h2 id=&quot;排查数据&quot;&gt;排查数据&lt;/h2&gt;
&lt;p&gt;nginx抛出502,证明是它的反向代理出错，这个代理php-cgi挂掉了，我用的是php-fpm，出了问题。在宝塔默认php-fpm配置有设置日志输出&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
error_log = /www/server/php/72/var/log/php-fpm.log
[www]
slowlog = var/log/slow.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;php-fpm-配置&quot;&gt;php-fpm 配置&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
pid = /www/server/php/72/var/run/php-fpm.pid
error_log = /www/server/php/72/var/log/php-fpm.log
log_level = notice

[www]
listen = /tmp/php-cgi-72.sock
listen.backlog = -1
listen.allowed_clients = 127.0.0.1
listen.owner = www
listen.group = www
listen.mode = 0666
user = www
group = www
pm = dynamic
pm.status_path = /phpfpm_72_status
pm.max_children = 150
pm.start_servers = 30
pm.min_spare_servers = 30
pm.max_spare_servers = 150
request_terminate_timeout = 100
request_slowlog_timeout = 30
slowlog = var/log/slow.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;机器配置阿里云4 vCPU 8 GiB ( 共享计算型 n1, ecs.n1.large )，&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;查看php-fpmlog-部分内容&quot;&gt;查看php-fpm.log 部分内容&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;p&gt;这张图显示，有两部分内容：&lt;/p&gt;

&lt;p&gt;1、php-fpm worker进程由于处理的程序超过109s左右(环境request_terminate_timeout = 100)，进程发出的signal 15(SIGTERM)。
对于signal 15(SIGTERM) 的 SIGTERM，查阅了下，是说：系统会发送一个SIGTERM的信号给对应的程序。
当程序接收到该signal后，将会发生以下的事情：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1、程序立刻停止&lt;/li&gt;
  &lt;li&gt;2、该程序释放相应资源后再停止&lt;/li&gt;
  &lt;li&gt;3、程序可能仍然继续运行&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;大部分程序接收到SIGTERM信号后，会先释放自己的资源，然后在停止。但是也有程序可以在接受到信号量后，做一些其他的事情，
并且这些事情是可以配置的。如果程序正在等待IO，可能就不会立马做出响应。也就是说，SIGTERM多半是会被阻塞的、忽略。&lt;/p&gt;

&lt;p&gt;2、带有请求的具体链接，显示请求太慢，超过了39s(request_slowlog_timeout = 30),记录了log。&lt;/p&gt;

&lt;h3 id=&quot;查看slowlog-部分内容&quot;&gt;查看slow.log 部分内容&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FnNWSnsLDg0mjBKt2x4ARGIBrlk6&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;p&gt;这张图显示，请求处理只到了框架初始代码和权限验证那块，并没用实际到达业务代码程序。可排除sql慢查询或者
业务代码问题。&lt;/p&gt;

&lt;h3 id=&quot;查看框架的tp51-log-部分内容&quot;&gt;查看框架的TP5.1 log 部分内容&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FjPr7FPhs1lf91PR__DOZIN6ZRzO&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;p&gt;这张图显示，请求处理还没到csrf验证层就阻塞了!!!&lt;/p&gt;

&lt;h3 id=&quot;面板进程情况&quot;&gt;面板进程情况&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FnfJPvsSClmAGAbKGbCP2bhcVLI7&quot; alt=&quot;FnfJPvsSClmAGAbKGbCP2bhcVLI7&quot; /&gt;&lt;/p&gt;

&lt;p&gt;这张图显示是那个时间段抛出502宕机10来分钟php-fpm记录下来的status。数据显示，请求数量有53441,但是活跃进程数只有1个，
并且产生了450个慢查询数量。&lt;/p&gt;

&lt;h3 id=&quot;session-阻塞&quot;&gt;Session 阻塞&lt;/h3&gt;
&lt;p&gt;既然不是慢SQL产生的问题，并且有大量请求没有达到crsf验证层，只到达了crsf层上面的权限验证层，权限又是基于cookies和session的，那就推断是session阻塞引起的。
什么会引起session阻塞呢？查阅了资料，并写下面代码在本地测试。&lt;/p&gt;

&lt;p&gt;前端js code（三个请求ajax1、ajax2、ajax3同时进行）&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;script src=&quot;https://cdn.bootcss.com/jquery/3.4.0/jquery.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;script&amp;gt;
    var a = 1;
    var b = 1;
    var c = 1;
    function ajax1(){
        $.get('/hello?from=a', function(){
            console.log('a' , a);
            a++;
            ajax1();
        });
    }
    function ajax2(){
        $.get('/hello?from=b', function(){
            console.log('b',b);
            b++;
            ajax2();
        });
    }
    function ajax3(){
        $.get('/hello?from=c', function(){
            console.log('c',c);
            c++;
            ajax3();
        });
    }

    function beginAjax(){
        ajax1();
        ajax2();
        ajax3();
    }
    beginAjax();
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;TP5.1后端code&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app\index\controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;think\Controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Index&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ThinkPHP5'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'qanda'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//session是tp5.1的定义的方法&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'data'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;session_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;php-fpm.conf配置&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;request_slowlog_timeout = 16
request_terminate_timeout = 20
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;火狐浏览器&quot;&gt;火狐浏览器&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fi30BAxREfNBpYLRLMXJrS_vCzop&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;火狐浏览器测试，偶尔会出现刚开始返回的session_id不一致问题同时响应的时间a,b,c三个不一样参数请求响应都在5s多一点，
不过后面返回的session_id就一致了，同时响应的时间也变为了15s+了。&lt;/p&gt;

&lt;h3 id=&quot;chrome浏览器&quot;&gt;chrome浏览器&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FvVEgokNtB95OjJRUcH21E2BCvCY&quot; alt=&quot;&quot; /&gt;
chrome浏览器刚开始返回的session_id就一致，但是耗时较长，后面趋于稳定的15s+。&lt;/p&gt;

&lt;h3 id=&quot;将测试code放到laravel62测试&quot;&gt;将测试code放到Laravel6.2测试。&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fn6BmTtjJNXJgOyGdGe74yt10cpd&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;稳定输出5s+，那就是TP5.1的session出现bug了！！！&lt;/p&gt;

&lt;h3 id=&quot;tp51的session为什么会出现问题&quot;&gt;TP5.1的Session为什么会出现问题&lt;/h3&gt;
&lt;p&gt;Session阻塞的原因网上大部分说是session_start(),使用完记得session_write_close()。难道TP5.1使用了后没close???
查看TP5.1源码：&lt;/p&gt;

&lt;p&gt;1、
&lt;img src=&quot;http://img.zzhpeng.cn/FqC_5ivD1cFKjx2A06w6gALb4pzo&quot; alt=&quot;&quot; /&gt;
2、
&lt;img src=&quot;http://img.zzhpeng.cn/FsD9JQa5VlMSAhK-ijYmwEMx0t01&quot; alt=&quot;&quot; /&gt;
3、
&lt;img src=&quot;http://img.zzhpeng.cn/FjgcLLdJglPrpHiWnnbjfIyQMit2&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;还真是TP5.1没close，这bug就很容易让系统处于502状态，竟然没人遇到过并且修复吗？反映并且提交issue修复！看了下最新的TP6,借鉴Laravel的Session、Cookies组件化了
TP的这个bug也就不存在了。&lt;/p&gt;

&lt;h2 id=&quot;解决&quot;&gt;解决&lt;/h2&gt;
&lt;p&gt;系统还是要用，修改配置文件，用TP5.1 session锁，code 如下：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;return [
    'id'             =&amp;gt; '',
    // SESSION_ID的提交变量,解决flash上传跨域
    'var_session_id' =&amp;gt; '',
    // SESSION 前缀
    'prefix'         =&amp;gt; 'think',
    // 驱动方式 支持redis memcache memcached
    'type'           =&amp;gt; '',
    // 是否自动开启 SESSION
    'auto_start'     =&amp;gt; true,
    'use_lock'     =&amp;gt; true,
];
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;修改后，响应时间正常了
&lt;img src=&quot;http://img.zzhpeng.cn/FiRwyQzfDp9ZYp8EzPCH6GCWXEb7&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;注意与疑惑&quot;&gt;注意与疑惑&lt;/h2&gt;
&lt;h3 id=&quot;注意&quot;&gt;注意&lt;/h3&gt;
&lt;p&gt;1、查到资料看到不是代码的引起的502，而是环境配置。
https://www.cnblogs.com/zenghansen/p/4647004.html&lt;/p&gt;

&lt;h3 id=&quot;疑惑&quot;&gt;疑惑&lt;/h3&gt;
&lt;p&gt;1、为什么执行时间session_write_close不执行，返回时间会累加呢？&lt;/p&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://www.cnblogs.com/skillCoding/archive/2012/04/09/2439296.html&quot;&gt;PHP的Session阻塞问题探讨&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2、&lt;a href=&quot;https://www.cnblogs.com/yufeng218/p/9911368.html&quot;&gt;session 和 cookie&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;3、&lt;a href=&quot;https://blog.csdn.net/qq_26836575/article/details/82147558&quot;&gt;SIGKILL和SIGTERM、SIGINT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;4、&lt;a href=&quot;https://www.cnblogs.com/pheye/p/7890065.html&quot;&gt;如何管理Session(防止恶意共享账号)——理论篇&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;5、&lt;a href=&quot;https://www.cnblogs.com/zenghansen/p/4647004.html&quot;&gt;nginx下php频繁卡死502&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 25 Nov 2019 00:00:00 +0800</pubDate>
				<link>/nginx502_1.html</link>
				<guid isPermaLink="true">/nginx502_1.html</guid>
			</item>
		
			<item>
				<title>Redis的原子性解决并发问题</title>
				<description>&lt;h3 id=&quot;问题概述&quot;&gt;问题概述&lt;/h3&gt;

&lt;p&gt;最近根据运营那边提供BUG反馈信息提示，出现了仓库商品冻结数量少了，导致出库异常现象。仓库商品库存信息
表设计是库存num，冻结数frozen_num。当下订单的时候，frozen_num + 1。订单结束，商品库存num - 
出库数量，冻结数frozen_num - 出库数量。但是在高并发下，多个请求同时进来，订单下了多个，frozen_num只加了1，那样出库的时候就会产生异常。&lt;/p&gt;

&lt;h3 id=&quot;初步方案选择利用redis的原子性实现锁&quot;&gt;初步方案选择，利用redis的原子性，实现锁&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;1、Redis SETNX&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Redis SETNX的用法是SETNX key value。而返回值，如果设置key成功会返回1，没有被设置会返回0。
简单说就是SET if Not eXists，不存在就可以被设置。&lt;/p&gt;

&lt;p&gt;然后根据这个特性，用SETNX的value设置过期时间，结合Redis DEL key [key …]，用过期时间和程序
是否执行完成，去判断是否可以删除这个key来实现原子性控制。伪代码如下：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;if 获取锁成功
    1、执行程序
    2、解锁
else 
    //获取锁失败，判断过期时间
    if 过期并且超时，
        1、解锁
    if 再次获取锁
        1.执行程序
        2、解锁   
    else
        不处理，请求结束
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;获取锁失败，判断value这个过期时间解锁很好的解决了进程异常解锁程序不执行产生死锁问题，但是程序解锁再获取锁的过程
是非原子性的，所以会存在极端现象，假设有进程P1、P2，会出现如下情况。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1、P1和P2都获取锁失败，同时进行过期判断，并且都通过。&lt;/li&gt;
  &lt;li&gt;2、P1解锁成功，再获取锁。&lt;/li&gt;
  &lt;li&gt;3、P2又解锁成功，也获取了锁。&lt;/li&gt;
  &lt;li&gt;4、P1、P2同时获取锁成功。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;不过官方给了替换方案，原话为&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Anyway even assuming a single-instance locking primitive, starting with 2.6.12
it is possible to create a much simpler locking primitive, equivalent to the 
one discussed here, using the SET command to acquire the lock, and a simple 
Lua script to release the lock. The pattern is documented in the SET command 
page.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;表达的就是从redis 2.6.12版本起,可以用set实现setnx功能并且可以设置锁过期时间和原子性语言的lua脚本释放锁，去替换了setnx。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、Redis SET&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;用了set之后程序就不用去判断是否过期去程序解锁了，也实现了原子性。伪代码变为：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;if 获取锁成功
    1、执行程序
    2、解锁
else 
    //获取锁失败
    1、不处理
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;演示代码&quot;&gt;演示代码&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;数据库&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;订单表&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DROP TABLE IF EXISTS `order`;
CREATE TABLE `order` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `num` int(11) NOT NULL DEFAULT '0' COMMENT '销售商品数量',
  `store_depot_batch_id` int(11) NOT NULL COMMENT '门店仓库批次id',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '添加时间，',
  `update_time` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `delete_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='订单表';

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;门店仓库批次表&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DROP TABLE IF EXISTS `depot_store_depot_batch`;
CREATE TABLE `depot_store_depot_batch` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `num` int(11) NOT NULL DEFAULT '0' COMMENT '总数量，有效数量=总数-冻结数量',
  `frozen_num` int(11) NOT NULL DEFAULT '0' COMMENT '冻结数量',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '添加时间，入库时间',
  `update_time` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `delete_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='门店仓库批次管理';

INSERT INTO `depot_store_depot_batch` VALUES(1,10,0,NOW(),NOW(),NULL);

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;门店仓库批次冻结操作表&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DROP TABLE IF EXISTS `depot_store_depot_batch_frozen_record`;
CREATE TABLE `depot_store_depot_batch_frozen_record` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `depot_store_depot_batch_id` int(11) NOT NULL COMMENT '门店仓库批次管理id',
  `before_frozen_num` int(11) NOT NULL COMMENT '仓库冻结数量变动前',
  `after_frozen_num` int(11) NOT NULL COMMENT '仓库冻结数量变动后',
  `frozen_num` int(11) DEFAULT '0',
  `desc` varchar(100) NOT NULL COMMENT '描述',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '添加时间',
  `update_time` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='门店仓库冻结记录';

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;代码，实现下单、更新仓库冻结数和添加冻结操作记录&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;没有加redis锁的代码&quot;&gt;没有加redis锁的代码&lt;/h4&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;/**
 * Created by PhpStorm.
 * User: zzhpeng
 * Date: 2019/11/2
 * Time: 11:32 AM
 */&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;PDO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'mysql:host=127.0.0.1;dbname=store'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'123456789'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;//销售数量&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//查询门店仓库批次信息&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;select * from  `depot_store_depot_batch` where id =1 limit 1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//操作后冻结数量&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//开启事务&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;beginTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'商品已售罄了'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//下单主表&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `order` VALUES (null,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,1,NOW(),NOW(),null)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lastInsertId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;update `depot_store_depot_batch` set `frozen_num`=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; WHERE id=1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;//冻结记录操作sql&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `depot_store_depot_batch_frozen_record` VALUES (null,1,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,'并发测试',NOW(),NOW())&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;//提交事务&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'下单成功,订单id为'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\Exception&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//回滚事务&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;rollBack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ab压力测试，ab -n 100 -c 10 http://127.0.0.1:83/redis.php,然后查看三个表mysql记录。&lt;/p&gt;

&lt;p&gt;查看Order表情况，显示了35row order。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `order`;
+----+-----+----------------------+---------------------+---------------------+-------------+
| id | num | store_depot_batch_id | create_time         | update_time         | delete_time |
+----+-----+----------------------+---------------------+---------------------+-------------+
|  1 |   1 |                    1 | 2019-11-03 19:08:06 | 2019-11-03 19:08:06 | NULL        |
|  2 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  3 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  4 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  5 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  6 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  7 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  8 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  9 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 10 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 11 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 12 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 13 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 14 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 15 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 16 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 17 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 18 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 19 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 20 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 21 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 22 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 23 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 24 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 25 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 26 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 27 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 28 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 29 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 30 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 31 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 32 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 33 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 34 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 35 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
+----+-----+----------------------+---------------------+---------------------+-------------+
35 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;查看depot_store_depot_batch表情况，确实冻结了10个。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `depot_store_depot_batch`;
+----+-----+------------+---------------------+---------------------+-------------+
| id | num | frozen_num | create_time         | update_time         | delete_time |
+----+-----+------------+---------------------+---------------------+-------------+
|  1 |  10 |         10 | 2019-11-03 19:06:59 | 2019-11-03 19:06:59 | NULL        |
+----+-----+------------+---------------------+---------------------+-------------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看depot_store_depot_batch_frozen_record表情况，35row记录。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from depot_store_depot_batch_frozen_record;
+------+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
| id   | depot_store_depot_batch_id | before_frozen_num | after_frozen_num | frozen_num | desc | create_time         | update_time         |
+------+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
| 2342 |                          1 |                 0 |                1 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2343 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2344 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2345 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2346 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2347 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2348 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2349 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2350 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2351 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2352 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2353 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2354 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2355 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2356 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2357 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2358 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2359 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2360 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2361 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2362 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2363 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2364 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2365 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2366 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2367 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2368 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2369 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2370 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2371 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2372 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2373 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2374 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2375 |                          1 |                 9 |               10 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2376 |                          1 |                 9 |               10 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
+------+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
35 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;结论就是，虽然冻结数是对了，但是出了很多超卖的订单&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;加redis锁的代码&quot;&gt;加redis锁的代码&lt;/h4&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;/**
 * Created by PhpStorm.
 * User: zzhpeng
 * Date: 2019/11/2
 * Time: 11:32 AM
 */&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Lock&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt;   &lt;span class=&quot;nv&quot;&gt;$_redis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__construct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Redis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'127.0.0.1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getInstance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt;  &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;sd&quot;&gt;/**
     * 加锁
     * @author: zzhpeng
     * Date: 2019/11/2
     * @param $key string 锁名称
     * @param $expTTL int 多久过期，秒单位
     *
     * @return bool
     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$expTTL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//set 实现setnx 和 expire()的效果&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$isLock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$expTTL&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'nx'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ex'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$expTTL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isLock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;  &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;sd&quot;&gt;/**
     * @param $key string 解锁
     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;PDO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'mysql:host=127.0.0.1;dbname=store'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'123456789'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;//销售数量&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//锁名&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'store_depot_batch_lock'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//加锁&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getInstance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//加锁失败抛出网络异常错误&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;RedisException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'网络异常,请稍后再试'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//开启事务&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;beginTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//查询门店仓库批次信息&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;select * from  `depot_store_depot_batch` where id =1 limit 1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//操作后冻结数量&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'商品已售罄了'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//下单主表&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `order` VALUES (null,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,1,NOW(),NOW(),null)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lastInsertId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//下单是否成功判断&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'下单失败,请稍后再试'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//更新仓库&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;update `depot_store_depot_batch` set `frozen_num`=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; WHERE id=1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//冻结记录操作sql&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `depot_store_depot_batch_frozen_record` VALUES (null,1,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,'并发测试',NOW(),NOW())&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//提交事务&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//解锁&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'下单成功,订单id为'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\RedisException&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\Exception&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//回滚事务&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;inTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()){&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;rollBack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;//解锁&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ab压力测试，ab -n 1000 -c 100 http://127.0.0.1:83/redis.php&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; ~ ab -n 1000 -c 100 http://127.0.0.1:83/redis.php
This is ApacheBench, Version 2.3 &amp;lt;$Revision: 1826891 $&amp;gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking 127.0.0.1 (be patient)
Completed 100 requests
Completed 200 requests
Completed 300 requests
Completed 400 requests
Completed 500 requests
Completed 600 requests
Completed 700 requests
Completed 800 requests
Completed 900 requests
Completed 1000 requests
Finished 1000 requests


Server Software:        nginx/1.15.1
Server Hostname:        127.0.0.1
Server Port:            83

Document Path:          /redis.php
Document Length:        25 bytes

Concurrency Level:      100
Time taken for tests:   2.508 seconds
Complete requests:      1000
Failed requests:        991
   (Connect: 0, Receive: 0, Length: 991, Exceptions: 0)
Total transferred:      189001 bytes
HTML transferred:       27001 bytes
Requests per second:    398.65 [#/sec] (mean)
Time per request:       250.845 [ms] (mean)
Time per request:       2.508 [ms] (mean, across all concurrent requests)
Transfer rate:          73.58 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.8      0       4
Processing:    28  232  37.8    239     389
Waiting:       28  232  37.8    239     389
Total:         33  233  37.5    239     389

Percentage of the requests served within a certain time (ms)
  50%    239
  66%    248
  75%    254
  80%    258
  90%    269
  95%    284
  98%    312
  99%    320
 100%    389 (longest request)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看Order表情况，显示了10row order。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `order`;
+----+-----+----------------------+---------------------+---------------------+-------------+
| id | num | store_depot_batch_id | create_time         | update_time         | delete_time |
+----+-----+----------------------+---------------------+---------------------+-------------+
|  1 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  2 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  3 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  4 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  5 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  6 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  7 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  8 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  9 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
| 10 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
+----+-----+----------------------+---------------------+---------------------+-------------+
10 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看depot_store_depot_batch表情况，确实冻结了10个。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `depot_store_depot_batch`;
+----+-----+------------+---------------------+---------------------+-------------+
| id | num | frozen_num | create_time         | update_time         | delete_time |
+----+-----+------------+---------------------+---------------------+-------------+
|  1 |  10 |         10 | 2019-11-04 06:33:43 | 2019-11-04 06:33:43 | NULL        |
+----+-----+------------+---------------------+---------------------+-------------+
1 row in set (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看depot_store_depot_batch_frozen_record表情况，10row记录。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from depot_store_depot_batch_frozen_record;
+----+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
| id | depot_store_depot_batch_id | before_frozen_num | after_frozen_num | frozen_num | desc | create_time         | update_time         |
+----+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
|  1 |                          1 |                 0 |                1 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  2 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  3 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  4 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  5 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  6 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  7 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  8 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  9 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
| 10 |                          1 |                 9 |               10 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
+----+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
10 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;结论就是，我加大的压力测试，结果也是我们想要的&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;注意与疑惑&quot;&gt;注意与疑惑&lt;/h3&gt;
&lt;p&gt;注意：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1、要用多进程的php-fpm测试，不能用单进程的cli。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;疑惑：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1、在redis set 10秒过期后，糟糕情况就是程序还没执行完成set过期了，导致超卖现象。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1、&lt;a href=&quot;https://www.jianshu.com/p/0eadec61e737&quot;&gt;利用Redis锁解决高并发问题 - 简书&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2、&lt;a href=&quot;http://www.sohu.com/a/240877096_99896109&quot;&gt;漫画：什么是分布式锁？&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Sat, 02 Nov 2019 00:00:00 +0800</pubDate>
				<link>/redis-set.html</link>
				<guid isPermaLink="true">/redis-set.html</guid>
			</item>
		
			<item>
				<title>Mysql使用IN功能相关与性能对比</title>
				<description>&lt;h3 id=&quot;问题概述&quot;&gt;问题概述&lt;/h3&gt;
&lt;p&gt;平时Mysql喜欢先sql语句找出id字符串，然后用in后面接（id，id，……）去查找数据。查阅相关文章，说sql语句长度有限制，随着数据增长就不能执行，但是
这个长度却很大，一般可以不用考虑。&lt;/p&gt;

&lt;p&gt;查看方法。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt;show variables like '%max_allowed_pack%'
+--------------------------+-----------------+
| Variable_name            | Value           |
+--------------------------+-----------------+
| max_allowed_packet       | 1073741824      |
| slave_max_allowed_packet | 1073741824      |
+--------------------------+-----------------+
返回行数：[2]，耗时：7 ms.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;根据返回结果可以看出，这个最大长度是很大的。&lt;/p&gt;

&lt;h3 id=&quot;in相关操作和替代方法对比&quot;&gt;IN相关操作和替代方法对比&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;1、IN后面接主键字符串（ 概念错误SELECT GROUP_CONCAT(order_id,’’) FROM order_action WHERE NAME = ‘user_add’ 查找出来的并不是字符串，而是数据集 ）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;代码&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` 
WHERE
	id IN ( SELECT GROUP_CONCAT(order_id,'') FROM order_action WHERE NAME = 'user_add' )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果显示，order表需要找全部行，order_action也是。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+--------------------+--------------+------------+------+---------------+------+---------+------+-------+----------+-------------+
| id | select_type        | table        | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |
+----+--------------------+--------------+------------+------+---------------+------+---------+------+-------+----------+-------------+
|  1 | PRIMARY            | order        | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 17239 |   100.00 | Using where |
|  2 | DEPENDENT SUBQUERY | order_action | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 20660 |    10.00 | Using where |
+----+--------------------+--------------+------------+------+---------------+------+---------+------+-------+----------+-------------+
2 rows in set, 1 warning (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;2、in 后面接 select 数据集&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;代码&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` 
WHERE
	id IN ( SELECT order_id FROM order_action WHERE NAME = 'user_add' )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果显示，会创建临时表&lt;subquery2&gt;，order表只需要查1rows，order_action表查所有行。&lt;/subquery2&gt;&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+--------------+--------------+------------+--------+---------------+---------+---------+----------------------+-------+----------+-------------+
| id | select_type  | table        | partitions | type   | possible_keys | key     | key_len | ref                  | rows  | filtered | Extra       |
+----+--------------+--------------+------------+--------+---------------+---------+---------+----------------------+-------+----------+-------------+
|  1 | SIMPLE       | &amp;lt;subquery2&amp;gt;  | NULL       | ALL    | NULL          | NULL    | NULL    | NULL                 |  NULL |   100.00 | NULL        |
|  1 | SIMPLE       | order        | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | &amp;lt;subquery2&amp;gt;.order_id |     1 |   100.00 | NULL        |
|  2 | MATERIALIZED | order_action | NULL       | ALL    | NULL          | NULL    | NULL    | NULL                 | 20649 |    10.00 | Using where |
+----+--------------+--------------+------------+--------+---------------+---------+---------+----------------------+-------+----------+-------------+
3 rows in set, 1 warning (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;3、用 join 替换 in&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;代码&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` AS ot
	INNER JOIN order_action oat ON oat.order_id = ot.id 
	AND oat.NAME = 'user_add'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果显示，不创建临时表，但order表只需要查1rows，order_action表查所有行。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+-------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref               | rows  | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+-------+----------+-------------+
|  1 | SIMPLE      | oat   | NULL       | ALL    | NULL          | NULL    | NULL    | NULL              | 20653 |    10.00 | Using where |
|  1 | SIMPLE      | ot    | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | sima.oat.order_id |     1 |   100.00 | NULL        |
+----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+-------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;4、exist 替代 in （效率不行）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;代码&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` AS ot 
WHERE
	EXISTS ( SELECT order_id FROM order_action oat WHERE ot.id = oat.order_id AND NAME = 'user_add' ) 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果测试的是两张关联的表都查了所有。所以exist效率不行。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+--------------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+
| id | select_type        | table | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |
+----+--------------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+
|  1 | PRIMARY            | ot    | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 17233 |   100.00 | Using where |
|  2 | DEPENDENT SUBQUERY | oat   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 20656 |     1.00 | Using where |
+----+--------------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+
2 rows in set, 2 warnings (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;explain-分析-sql-语句的相关属性解析&quot;&gt;explain 分析 sql 语句的相关属性解析&lt;/h3&gt;

&lt;p&gt;连接操作的TYPE类型&lt;/p&gt;

&lt;p&gt;（1）SYSTEM&lt;/p&gt;

&lt;p&gt;CONST的特例，当表上只有一条元组匹配&lt;/p&gt;

&lt;p&gt;（2）CONST&lt;/p&gt;

&lt;p&gt;WHERE条件筛选后表上至多有一条元组匹配时，比如WHERE ID = 2 （ID是主键，值为2的要么有一条要么没有）&lt;/p&gt;

&lt;p&gt;（3）EQ_REF&lt;/p&gt;

&lt;p&gt;参与连接运算的表是内表（在代码实现的算法中，两表连接时作为循环中的内循环遍历的对象，这样的表称为内表）。
基于索引（连接字段上存在唯一索引或者主键索引，且操作符必须是“=”谓词，索引值不能为NULL）做扫描，使得对外表的一条元组，内表只有唯一一条元组与之对应。&lt;/p&gt;

&lt;p&gt;（4）REF&lt;/p&gt;

&lt;p&gt;可以用于单表扫描或者连接。参与连接运算的表，是内表。
基于索引（连接字段上的索引是非唯一索引，操作符必须是“=”谓词，连接字段值不可为NULL）做扫描，使得对外表的一条元组，内表可有若干条元组与之对应。&lt;/p&gt;

&lt;p&gt;（5）REF_OR_NULL&lt;/p&gt;

&lt;p&gt;类似REF，只是搜索条件包括：连接字段的值可以为NULL的情况，比如 where col = 2 or col is null&lt;/p&gt;

&lt;p&gt;（6）RANGE&lt;/p&gt;

&lt;p&gt;范围扫描，基于索引做范围扫描，为诸如BETWEEN，IN，&amp;gt;=，LIKE类操作提供支持&lt;/p&gt;

&lt;p&gt;（7）INDEX_SCAN&lt;/p&gt;

&lt;p&gt;索引做扫描，是基于索引在索引的叶子节点上找满足条件的数据（不需要访问数据文件）&lt;/p&gt;

&lt;p&gt;（8）ALL&lt;/p&gt;

&lt;p&gt;全表扫描或者范围扫描：不使用索引，顺序扫描，直接读取表上的数据（访问数据文件）&lt;/p&gt;

&lt;p&gt;（9）UNIQUE_SUBQUERY&lt;/p&gt;

&lt;p&gt;在子查询中，基于唯一索引进行扫描，类似于EQ_REF&lt;/p&gt;

&lt;p&gt;（10）INDEX_SUBQUERY&lt;/p&gt;

&lt;p&gt;在子查询中，基于除唯一索引之外的索引进行扫描&lt;/p&gt;

&lt;p&gt;（11）INDEX_MERGE&lt;/p&gt;

&lt;p&gt;多重范围扫描。两表连接的每个表的连接字段上均有索引存在且索引有序，结果合并在一起。适用于作集合的并、交操作。&lt;/p&gt;

&lt;p&gt;（12）FT&lt;/p&gt;

&lt;p&gt;FULL TEXT，全文检索&lt;/p&gt;

&lt;h3 id=&quot;结论&quot;&gt;结论&lt;/h3&gt;

&lt;p&gt;实际测试显示，in数据集是最快的。所有优先考虑in数据集这种会创建临时表的方式。&lt;/p&gt;

&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1、&lt;a href=&quot;https://blog.csdn.net/seelye/article/details/46453651&quot;&gt;mysql explain 的type解释&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2、&lt;a href=&quot;https://blog.csdn.net/fukaiit/article/details/83515439&quot;&gt;MySql中in查询效率低的替代方法&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 07 Oct 2019 00:00:00 +0800</pubDate>
				<link>/mysql-in.html</link>
				<guid isPermaLink="true">/mysql-in.html</guid>
			</item>
		
			<item>
				<title>更换mac默认bash shell为zsh</title>
				<description>&lt;h3 id=&quot;问题概述&quot;&gt;问题概述&lt;/h3&gt;
&lt;p&gt;原本的bash shell用起来也挺快捷，但是在git操作切换分支之类的没有提醒用起来没那么爽。很久前老大推荐我用，
之前回复是勤奋点，多打几个字母也有好处。今天再次看到相关的blog，决定换起来，结果就是，真香！&lt;/p&gt;

&lt;h3 id=&quot;更换brew源&quot;&gt;更换brew源&lt;/h3&gt;
&lt;p&gt;原本的源是github的，由于墙的问题可能会有点慢，所以换成国内的源。&lt;/p&gt;

&lt;p&gt;替换brew.git&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd &quot;$(brew --repo)&quot;
git remote set-url origin https://mirrors.ustc.edu.cn/brew.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;替换homebrew-core.git:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd &quot;$(brew --repo)/Library/Taps/homebrew/homebrew-core&quot;
git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;更新Homebrew&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;brew update
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;安装&quot;&gt;安装&lt;/h3&gt;

&lt;p&gt;安装zsh&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;brew install zsh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;安装oh-my-zsh&lt;/p&gt;

&lt;p&gt;到home目录。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd ~
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;从github下载oh-my-zsh。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone git://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;生成zsh配置文件zshrc。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cp ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;兼容bash设置的参数，将原来设置在bash的参数copy到zsh的~/.zshrc文件下。&lt;/p&gt;

&lt;p&gt;修改默认shell为zsh&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;chsh -s /bin/zsh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;问题&quot;&gt;问题&lt;/h3&gt;

&lt;p&gt;chsh -s /bin/zsh 后出现 chsh: no changes made&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dscl . -read /Users/$USER/ UserShell
exec su - $USER
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;参考&quot;&gt;参考&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1、&lt;a href=&quot;https://www.jianshu.com/p/677a9bb1ac29&quot;&gt;Mac 下使用zsh - 简书&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2、&lt;a href=&quot;https://www.howie6879.cn/post/2019/06_oh_my_zsh/&quot;&gt;oh-my-zsh：让终端飞 - 老胡的储物柜&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 30 Sep 2019 00:00:00 +0800</pubDate>
				<link>/zsh.html</link>
				<guid isPermaLink="true">/zsh.html</guid>
			</item>
		
			<item>
				<title>gitlab出现502问题</title>
				<description>&lt;h3 id=&quot;问题概述&quot;&gt;问题概述&lt;/h3&gt;
&lt;p&gt;上周，公司内部服务器重启，自搭建的gitlab仓库返回502。在这里先说明gitlab的搭建情况，用了宝塔管理，已经有了
nginx，所以不用gitlab自带的nginx服务，修改过程如下。&lt;/p&gt;

&lt;p&gt;1、修改配置文件，禁用内嵌 nginx&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo vim /etc/gitlab/gitlab.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;修改一下配置&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 关闭nginx服务
nginx['enable'] = false
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;应用修改的配置&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 重新加载配置
sudo gitlab-ctl reconfigure
# 重新启动
sudo gitlab-ctl restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2、设置宝塔的nginx代理转发,如下&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 添加upstream指向gitlab
upstream gitlab-workhorse {
  server unix:/var/opt/gitlab/gitlab-workhorse/socket  fail_timeout=0;
}


# 在server中添加
server
{

    ......

    location / {
            # serve static files from defined root folder;.
            # @gitlab-workhorse is a named location for the upstream fallback, see below
            try_files $uri $uri/index.html $uri.html @gitlab-workhorse;
    }

    location @gitlab-workhorse {
            # If you use https make sure you disable gzip compression 
            # to be safe against BREACH attack

            proxy_read_timeout 300; # Some requests take more than 30 seconds.
            proxy_connect_timeout 300; # Some requests take more than 30 seconds.
            proxy_redirect     off;

            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   Host              $http_host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Frame-Options   SAMEORIGIN;

            proxy_pass http://gitlab-workhorse;
    }

    location ~ ^/(assets)/  {
            root /opt/gitlab/embedded/service/gitlab-rails/public;
            # gzip_static on; # to serve pre-gzipped version
            expires max;
            add_header Cache-Control public;
    }

    .....
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后报出了502，查看nginx的error日志，提示权限问题。
&lt;img src=&quot;http://img.zzhpeng.cn/Fkn0XGjtnpSN-0bTrMNeFeWo3wxr&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;解决过程&quot;&gt;解决过程&lt;/h3&gt;
&lt;p&gt;看到/etc/gitlab/gitlab.rb文件有个说明，当不开启内部的nginx的时候，需要加一个外部的用户。这里的外部用户
即是指宝塔的nginx开启的用户www。&lt;/p&gt;

&lt;p&gt;1、查看nginx的开启用户
&lt;img src=&quot;http://img.zzhpeng.cn/FiqxjiPd1NGzUVLRyb9XmszwI9TE&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2、修改/etc/gitlab/gitlab.rb
&lt;img src=&quot;http://img.zzhpeng.cn/Fp5IQkW4PcGC4O_-kF_oelDWhQJF&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;应用修改的配置&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 重新加载配置
sudo gitlab-ctl reconfigure
# 重新启动
sudo gitlab-ctl restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;！！！但是，还是不行，还是502问题。你看，理论上没问题啊！&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;这里涉及到了socket文件通讯的问题，一旦建立连接就会一直连接，原权限之类的还是原来的。&lt;/p&gt;

&lt;p&gt;nginx代理流，文件socket服务转发&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;upstream gitlab-workhorse {
  server unix:/var/opt/gitlab/gitlab-workhorse/socket  fail_timeout=0;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;所以，需要重启nginx,让它重新加载conf配置文件，重新建立连接&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;额外&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;如何查看系统组情况和修改&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat /etc/group
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看socket文件权限&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FgyLa8Dd6ArOr3F--bvO2qDsoInw&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
</description>
				<pubDate>Sun, 22 Sep 2019 00:00:00 +0800</pubDate>
				<link>/linux-user-group-permission.html</link>
				<guid isPermaLink="true">/linux-user-group-permission.html</guid>
			</item>
		
			<item>
				<title>jenkins启动一段时间后掉线</title>
				<description>&lt;h2 id=&quot;问题&quot;&gt;问题&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;和gitlab使用的端口8080冲突，修改为了8088。然后每次jenkins启动过一段时间后会自动的down服务，
启动命令是service jenkins start。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;使用lsof -i:8080查看端口使用情况：
&lt;img src=&quot;http://img.zzhpeng.cn/FhgyPfOl3dr5UBcyGy0iMjavJ_3c&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;解决路程&quot;&gt;解决路程&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;尝试用另外一种方法启动,但还是使用旧的端口问题。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fiy7cWxbK29pDZZdUnqaosW5BDfC&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;搜索了下，找到了可以直接在启动后面加参数，改使用端口。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;java -jar jenkins.war --ajp13Port=-1 --httpPort=8088
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;挂在后台&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;nohup java -jar jenkins.war --ajp13Port=-1 --httpPort=8088 &amp;amp;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;再次出现问题&quot;&gt;再次出现问题&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;两种启动的数据文件不是用同一个的，用挂在后台的是新的数据库，需要重新注册admin，重新配置。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;解决~~待。。。。&lt;/p&gt;

&lt;h2 id=&quot;后续&quot;&gt;后续&lt;/h2&gt;
&lt;p&gt;这个问题，最终是用加大linux物理内存,机器是8G的内存。默认是没有设置swap的，我设置了8G的，最终java相关的应用，观察了几个月，如Eleasticsearch、Jenkis都稳定了。&lt;/p&gt;

&lt;h2 id=&quot;迭代&quot;&gt;迭代&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2019年09月18日 00:00:00 初稿&lt;/li&gt;
  &lt;li&gt;2019年12月27日 15:29:00 修改&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://blog.csdn.net/panruifang/article/details/14223323&quot;&gt;Jenkins 安装Address already in use问题&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2、&lt;a href=&quot;https://blog.csdn.net/sirchenhua/article/details/87861709&quot;&gt;Linux SWAP交换分区应该设置多大？&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Wed, 18 Sep 2019 00:00:00 +0800</pubDate>
				<link>/jenkins-auto-down.html</link>
				<guid isPermaLink="true">/jenkins-auto-down.html</guid>
			</item>
		
			<item>
				<title>elasticsearch业务问题</title>
				<description>&lt;h2 id=&quot;场景&quot;&gt;场景&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;要搜索的内容&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;P92325 iphone 7s plus 4G 黑色 美版 无锁
P92324 iphone 7 128g 金色 有锁 通用版
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;以为客户那边要求是，想的很简单&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1、iphone7splus  搜索-&amp;gt;P92325 iphone 7s plus 4G 黑色 美版 无锁&lt;/li&gt;
  &lt;li&gt;2、iphone 7s plus  搜索-&amp;gt;P92325 iphone 7s plus 4G 黑色 美版 无锁&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;实际输入情况,五花八门，还有这些情况&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1、iphone7splus  搜索-&amp;gt;P92325 iphone 7s plus 4G 黑色 美版 无锁&lt;/li&gt;
  &lt;li&gt;2、iphone 7s plus   搜索-&amp;gt;P92325 iphone 7s plus 4G 黑色 美版 无锁&lt;/li&gt;
  &lt;li&gt;3、iphone7sp 美版   搜索-&amp;gt;P92325 iphone 7s plus 4G 黑色 美版 无锁&lt;/li&gt;
  &lt;li&gt;4、iphone7 128g 美版   搜索-&amp;gt;P92324 iphone 7 128g 金色 有锁 通用版&lt;/li&gt;
  &lt;li&gt;5、iphone7s plus 美版   搜索-&amp;gt;iphone 7s plus 4G 黑色 美版 无锁&lt;/li&gt;
  &lt;li&gt;。。。&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;解决路程&quot;&gt;解决路程&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;错误解决方案，将搜索内容去掉空格，然后DOC的文章分析用IK分词器ik_max_word，
搜索用ik_smart,然后将搜索的词也去掉空格。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;1创建索引&quot;&gt;1、创建索引&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPUT http://localhost:9200/model
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;2设置索引属性map&quot;&gt;2、设置索引属性map&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/model/_mapping -H 'Content-Type:application/json' -d'
{
        &quot;properties&quot;: {
            &quot;name&quot;: {
                &quot;type&quot;: &quot;text&quot;,
                &quot;analyzer&quot;: &quot;ik_max_word&quot;,
                &quot;search_analyzer&quot;: &quot;ik_smart&quot;
            }
        }

}'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;3写入doc数据&quot;&gt;3、写入doc数据&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/model/_create/1 -H 'Content-Type:application/json' -d'
{&quot;content&quot;:&quot;P92325 iphone7splus4G黑色美版无锁&quot;}
'
curl -XPOST http://localhost:9200/model/_create/2 -H 'Content-Type:application/json' -d'
{&quot;content&quot;:&quot;P92324 iphone7128g金色有锁通用版&quot;}
'

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;4查看doc状态&quot;&gt;4、查看doc状态&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -X GET &quot;http://localhost:9200/_cat/indices?v&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5搜索数据&quot;&gt;5、搜索数据&lt;/h3&gt;

&lt;p&gt;iphone7splus 或 iphone 7s plus 查找搜索出 P92325 iphone 7s plus 4G 黑色 美版 无锁&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/model/_search  -H 'Content-Type:application/json' -d'
{
    &quot;size&quot; : 100,
    &quot;query&quot; : { &quot;match&quot; : { &quot;content&quot; : &quot;iphone7splus&quot; }}
  
}
'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;结果，啥都没：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
	&quot;took&quot;: 249,
	&quot;timed_out&quot;: false,
	&quot;_shards&quot;: {
		&quot;total&quot;: 1,
		&quot;successful&quot;: 1,
		&quot;skipped&quot;: 0,
		&quot;failed&quot;: 0
	},
	&quot;hits&quot;: {
		&quot;total&quot;: {
			&quot;value&quot;: 0,
			&quot;relation&quot;: &quot;eq&quot;
		},
		&quot;max_score&quot;: null,
		&quot;hits&quot;: []
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;为什么搜不出（一），因为P92325 iphone7splus4G黑色美版无锁 的文章分析不会出现iphone7splus。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;搜索词ik_smart分析&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XGET &quot;http://localhost:9200/model/_analyze&quot; -H 'Content-Type: application/json' -d'
{
   &quot;text&quot;:&quot;iphone7splus&quot;,&quot;tokenizer&quot;: &quot;ik_smart&quot;
}'

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果出现&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
	&quot;tokens&quot;: [{
		&quot;token&quot;: &quot;iphone7splus&quot;,
		&quot;start_offset&quot;: 0,
		&quot;end_offset&quot;: 12,
		&quot;type&quot;: &quot;LETTER&quot;,
		&quot;position&quot;: 0
	}]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查找文ik_max_word分析&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XGET &quot;http://localhost:9200/model/_analyze&quot; -H 'Content-Type: application/json' -d'
{
   &quot;text&quot;:&quot;iphone7splus4G黑色美版无锁&quot;,&quot;tokenizer&quot;: &quot;ik_max_word&quot;
}'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果，不会出现iphone7splus&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
{
    &quot;tokens&quot;: [
        {
            &quot;token&quot;: &quot;iphone7splus4g&quot;,
            &quot;start_offset&quot;: 0,
            &quot;end_offset&quot;: 14,
            &quot;type&quot;: &quot;LETTER&quot;,
            &quot;position&quot;: 0
        },
        {
            &quot;token&quot;: &quot;iphone&quot;,
            &quot;start_offset&quot;: 0,
            &quot;end_offset&quot;: 6,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 1
        },
        {
            &quot;token&quot;: &quot;7&quot;,
            &quot;start_offset&quot;: 6,
            &quot;end_offset&quot;: 7,
            &quot;type&quot;: &quot;ARABIC&quot;,
            &quot;position&quot;: 2
        },
        {
            &quot;token&quot;: &quot;splus&quot;,
            &quot;start_offset&quot;: 7,
            &quot;end_offset&quot;: 12,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 3
        },
        {
            &quot;token&quot;: &quot;4&quot;,
            &quot;start_offset&quot;: 12,
            &quot;end_offset&quot;: 13,
            &quot;type&quot;: &quot;ARABIC&quot;,
            &quot;position&quot;: 4
        },
        {
            &quot;token&quot;: &quot;g&quot;,
            &quot;start_offset&quot;: 13,
            &quot;end_offset&quot;: 14,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 5
        },
        {
            &quot;token&quot;: &quot;黑色&quot;,
            &quot;start_offset&quot;: 14,
            &quot;end_offset&quot;: 16,
            &quot;type&quot;: &quot;CN_WORD&quot;,
            &quot;position&quot;: 6
        },
        {
            &quot;token&quot;: &quot;美版&quot;,
            &quot;start_offset&quot;: 16,
            &quot;end_offset&quot;: 18,
            &quot;type&quot;: &quot;CN_WORD&quot;,
            &quot;position&quot;: 7
        },
        {
            &quot;token&quot;: &quot;无&quot;,
            &quot;start_offset&quot;: 18,
            &quot;end_offset&quot;: 19,
            &quot;type&quot;: &quot;CN_CHAR&quot;,
            &quot;position&quot;: 8
        },
        {
            &quot;token&quot;: &quot;锁&quot;,
            &quot;start_offset&quot;: 19,
            &quot;end_offset&quot;: 20,
            &quot;type&quot;: &quot;CN_CHAR&quot;,
            &quot;position&quot;: 9
        }
    ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;所以说，去掉空格方案是不行的，那就不去掉咯&lt;/p&gt;

&lt;p&gt;分析语句&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XGET &quot;http://localhost:9200/model/_analyze&quot; -H 'Content-Type: application/json' -d'
{
   &quot;text&quot;:&quot;iphone 7s plus 4G 黑色 美版 无锁&quot;,&quot;tokenizer&quot;: &quot;ik_max_word&quot;
}'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;结果，还是没有iphone7splus组合，那么搜索哪里也不去掉空格吧。这样就可以搜索到了。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
    &quot;tokens&quot;: [
        {
            &quot;token&quot;: &quot;iphone&quot;,
            &quot;start_offset&quot;: 0,
            &quot;end_offset&quot;: 6,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 0
        },
        {
            &quot;token&quot;: &quot;7s&quot;,
            &quot;start_offset&quot;: 7,
            &quot;end_offset&quot;: 9,
            &quot;type&quot;: &quot;LETTER&quot;,
            &quot;position&quot;: 1
        },
        {
            &quot;token&quot;: &quot;7&quot;,
            &quot;start_offset&quot;: 7,
            &quot;end_offset&quot;: 8,
            &quot;type&quot;: &quot;ARABIC&quot;,
            &quot;position&quot;: 2
        },
        {
            &quot;token&quot;: &quot;s&quot;,
            &quot;start_offset&quot;: 8,
            &quot;end_offset&quot;: 9,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 3
        },
        {
            &quot;token&quot;: &quot;plus&quot;,
            &quot;start_offset&quot;: 10,
            &quot;end_offset&quot;: 14,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 4
        },
        {
            &quot;token&quot;: &quot;4g&quot;,
            &quot;start_offset&quot;: 15,
            &quot;end_offset&quot;: 17,
            &quot;type&quot;: &quot;LETTER&quot;,
            &quot;position&quot;: 5
        },
        {
            &quot;token&quot;: &quot;4&quot;,
            &quot;start_offset&quot;: 15,
            &quot;end_offset&quot;: 16,
            &quot;type&quot;: &quot;ARABIC&quot;,
            &quot;position&quot;: 6
        },
        {
            &quot;token&quot;: &quot;g&quot;,
            &quot;start_offset&quot;: 16,
            &quot;end_offset&quot;: 17,
            &quot;type&quot;: &quot;ENGLISH&quot;,
            &quot;position&quot;: 7
        },
        {
            &quot;token&quot;: &quot;黑色&quot;,
            &quot;start_offset&quot;: 18,
            &quot;end_offset&quot;: 20,
            &quot;type&quot;: &quot;CN_WORD&quot;,
            &quot;position&quot;: 8
        },
        {
            &quot;token&quot;: &quot;美版&quot;,
            &quot;start_offset&quot;: 21,
            &quot;end_offset&quot;: 23,
            &quot;type&quot;: &quot;CN_WORD&quot;,
            &quot;position&quot;: 9
        },
        {
            &quot;token&quot;: &quot;无&quot;,
            &quot;start_offset&quot;: 24,
            &quot;end_offset&quot;: 25,
            &quot;type&quot;: &quot;CN_CHAR&quot;,
            &quot;position&quot;: 10
        },
        {
            &quot;token&quot;: &quot;锁&quot;,
            &quot;start_offset&quot;: 25,
            &quot;end_offset&quot;: 26,
            &quot;type&quot;: &quot;CN_CHAR&quot;,
            &quot;position&quot;: 11
        }
    ]
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;但是问题是，这只是解决了我的简单设想客户是这么简单的输入搜索。但是实际却不是，复杂的多。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;解决方案是将搜索分析都改为ik_max_word，这样搜索词和文章的颗粒度都分的很细。&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/model/_mapping -H 'Content-Type:application/json' -d'
{
        &quot;properties&quot;: {
            &quot;name&quot;: {
                &quot;type&quot;: &quot;text&quot;,
                &quot;analyzer&quot;: &quot;ik_max_word&quot;,
                &quot;search_analyzer&quot;: &quot;ik_max_word&quot;
            }
        }

}'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;注意的是，已经写入doc数据是不能修改的哦！&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;后记&quot;&gt;后记&lt;/h2&gt;
&lt;p&gt;1、去掉空格这种方案是听老大说的，太过信任和自己的懒惰，没实际去测试，导致进坑多时。&lt;/p&gt;

&lt;p&gt;2、探究技术要优先多看官方手册，其他来源资料只会让自己乱上加乱。&lt;/p&gt;

&lt;p&gt;3、功能流程要测一遍，很重要，处处都可能留下bug。错了之后数据乱，就更难调了。&lt;/p&gt;

&lt;p&gt;4、实际业务场景要多了解，多询问一线人员。&lt;/p&gt;

&lt;h2 id=&quot;参考&quot;&gt;参考&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://github.com/medcl/elasticsearch-analysis-ik&quot;&gt;GitHub - medcl/elasticsearch-analysis-ik: The IK Analysis plugin integrates Lucene IK analyzer into elasticsearch, support customized dictionary.&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Thu, 12 Sep 2019 00:00:00 +0800</pubDate>
				<link>/elasticsearch-actual_problem.html</link>
				<guid isPermaLink="true">/elasticsearch-actual_problem.html</guid>
			</item>
		
			<item>
				<title>云服务器磁盘扩容</title>
				<description>&lt;h1 id=&quot;操作前记得保存数据镜像&quot;&gt;操作前记得保存数据，镜像&lt;/h1&gt;
&lt;p&gt;数据丢失，概不负责！！&lt;/p&gt;

&lt;h1 id=&quot;数据盘扩容&quot;&gt;数据盘扩容&lt;/h1&gt;
&lt;h2 id=&quot;查看磁盘情况&quot;&gt;查看磁盘情况&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;查看已分区磁盘情况&lt;/p&gt;
  &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;df -h
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;  &lt;/div&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;查看磁盘情况&lt;/p&gt;
  &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo fdisk -lu
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;  &lt;/div&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;格式化&quot;&gt;格式化&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo mkfs.ext3 /dev/vdb5  //扩展分区，然后分逻辑分区
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;挂载&quot;&gt;挂载&lt;/h2&gt;
&lt;p&gt;创建目录&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo mkdir data
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;挂载&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo mount /dev/vdb5 /data
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;系统盘扩容&quot;&gt;系统盘扩容&lt;/h1&gt;

&lt;h2 id=&quot;阿里云扩容&quot;&gt;阿里云扩容&lt;/h2&gt;
&lt;p&gt;阿里云可以直接加大当前磁盘容量，然后用工具直接命令扩容，很容易。详细查看下面url
https://help.aliyun.com/document_detail/111738.html?spm=a2c4g.11186623.4.1.74dc7f67KyKnUd#section-gxq-3tw-dhb&lt;/p&gt;

&lt;h2 id=&quot;腾讯云&quot;&gt;腾讯云&lt;/h2&gt;

&lt;p&gt;重装系统扩容
&lt;img src=&quot;http://img.zzhpeng.cn/FtGTBTeftcin55OCyU8g-J2p_Q4J&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;内容地址：https://cloud.tencent.com/document/product/362/32539&lt;/p&gt;

&lt;h1 id=&quot;知其然&quot;&gt;知其然&lt;/h1&gt;
&lt;p&gt;fdisk [选项] –l &lt;disk&gt;  列出所有分区表&lt;/disk&gt;&lt;/p&gt;

&lt;p&gt;(1).选项&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;-b &amp;lt;size&amp;gt;  指定扇区大小（512，1024，2048或4096 B）
-c  关闭DOS兼容模式
-u &amp;lt;size&amp;gt;  以扇区编号取代柱面编号来表示每个分区的起始地址，一般与-l选项联合使用
-C &amp;lt;number&amp;gt;  指定柱面编号
-H &amp;lt;number&amp;gt;  指定磁头编号
-S &amp;lt;number&amp;gt;  指定磁道扇区编号
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;参考&quot;&gt;参考&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;1、&lt;a href=&quot;https://www.cnblogs.com/diantong/p/8820779.html&quot;&gt;Linux命令之fdisk - 苦逼运维 - 博客园&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Tue, 10 Sep 2019 00:00:00 +0800</pubDate>
				<link>/disk-extend.html</link>
				<guid isPermaLink="true">/disk-extend.html</guid>
			</item>
		
	</channel>
</rss>
